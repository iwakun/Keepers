bigd.news = {
	init: function() {
		bigd.currentNamespace = 'news';
		bigd.setCurrent();
	},
	inTheNews: {
		init: function() {
			var self = this;
			bigd.news.init();
			self.archive.init();
			setTimeout(function() {
				self.posts = new bigd.PostAccordion();
			}, 10);
			jQuery('.news-post')
				.waypoint(
					function(direction) {
						self.backgroundSwitch.addImageToQueue(this); 
					}, { offset: 86 }
				)
				.each(function() {
					var post = new bigd.Gallery(this);
				});
			// Plugin init
			setTimeout(function() {
				jQuery(document).trigger('readyajaxComplete');
			}, 500);
			self.backgroundSwitch.init();
		},
		archive: {
			el: {},
			next: {},
			prev: {},
			current: (new Date()).getFullYear(),
			init: function() {
				var self = this;
				self.el = jQuery('.archive');
				self.next = self.el.find('.archive-nav.next');
				self.prev = self.el.find('.archive-nav.prev');
				self.prev.on('click', function(e) {
					e.preventDefault();
					self.fetchYear(self.current - 1);
				});
				self.next.on('click', function(e) {
					e.preventDefault();
					self.fetchYear(self.current + 1);
				});
				self.fetchYear(self.current);
			},
			fetchYear: function(year) {
				var self = this;
				// Make an ajax call to update the archive content.
				jQuery.ajax({
					url: bigd.TEMPLATE_URL + 'ajax-fetch-page.php', 
					data: { url : 'http://' + bigd.BASE_URL + '/' + year + '/', pageType: 'child' },
					dataType: "json",
					success: function(result) {
						self.load(result, year);
					},
					error: function() {
						year -= 1;
						jQuery.ajax({
							url: bigd.TEMPLATE_URL + 'ajax-fetch-page.php', 
							data: { url : 'http://' + bigd.BASE_URL + '/' + year + '/', pageType: 'child' },
							dataType: "json",
							success: function(result) {
								self.load(result, year);
							},
							error: function() {
								jQuery('.archive-content').html('<h3>No posts found</h3>');
							}
						});
					}
				});
			},
			load: function(result, year) {
				var self = this;
				if(result.pagehtml !== null) {
					self.current = year;
					year = year + ''; // to string
					self.el
						.find('.archive-content').html(result.pagehtml).end()
						.find('.archive-date').html('' + 
							'<div class="content">' + 
							year.substring(0,2) + '<br/>' + 
							year.substring(2) + '</div>'
						);
					if(!result.extra.years.next) {
						self.next.hide();
					} else {
						self.next.show();
					}
					if(!result.extra.years.previous) {
						self.prev.hide();
					} else {
						self.prev.show();
					}
				}
			}
		},
		backgroundSwitch: {
			isAnimating: false,
			queue: [],
			init: function() {
				// Set first image
				var firstImage = jQuery('.news-post:first-child .featured_img img');
				jQuery('.news-background.bottom')
					.css('background-image', 'url(' + firstImage.attr('src') + ')');
				jQuery('.news-background.top')
					.css('background-image', 'url(' + firstImage.attr('src') + ')');
			},
			addImageToQueue: function(el) {
				var self = this;
				var image_src = jQuery(el).find('.featured_img img').attr('src');
				if(typeof image_src != 'undefined') {
					var image = new Image();
					image.src = image_src;
					image.onload = function() {
						self.queue.push(image_src);
						if(!self.isAnimating) {
							self.animate();
						}
					};
				}
			},
			animate: function() {
				var self = this;
				if(self.queue.length > 0) {
					self.isAnimating = true;
					var nextImage = self.queue.pop(); // Get last image
					self.queue = []; // Clear out the queue
					jQuery('.news-background.bottom')
						.css('background-image', 'url(' + nextImage + ')');
					jQuery('.news-background.top').fadeOut(1000, function() {
						jQuery('.news-background.top')
							.css('background-image', 'url(' + nextImage + ')')
							.show();
						self.isAnimating = false;
						self.animate();
					});
				} else {
					return false;
				}
			}
		},
		single: {
			init: function() {
				var self = this;
				jQuery('.news-post').each(function() {
					var post = new bigd.Gallery(this);
				});
				jQuery('.news-background').stop().css('opacity', 0);
				jQuery('.news-post').waypoint('destroy');
				// Plugin init
				setTimeout(function() {
					bigd.news.inTheNews.backgroundSwitch.init();
					jQuery('.news-background').animate({opacity: 1}, 500);
					jQuery(document).trigger('readyajaxComplete');
				}, 500);
			}
		}
	},
	social: {
		init: function() {
			var self = this;
			bigd.news.init();
			self.twitter.init();
			self.facebook.init();
		},
		twitter: {
			init: function() {
				//twitter jquery
				var monthNames = [ "NULL", "JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC" ];
				jQuery(".tweet-details #social").remove();
				var url = jQuery(".tweet-details a").attr('href');
				var numMonth = parseInt(jQuery(".tweet-details a time").attr('datetime').substring(5,7));
				var month = monthNames[numMonth];
				var day = jQuery(".tweet-details a time").attr('datetime').substring(8,10);
				//make the date box
				var date_html = '<div class="date">' +
					'<div class="content">' + day + '<br><span>' + month +'</span></div>' +
				'</div>';
				jQuery(".latest-tweets ul li").before(date_html);

				//make a retweet link
				//http://twitter.com/StationThirty7/status/451121708582567936
				var url_array = url.split('/');
				var retweet_url = "https://twitter.com/intent/retweet?tweet_id=" + 
					url_array[url_array.length - 1];

				//make a reply link
				var reply_url = "https://twitter.com/intent/tweet?in_reply_to=" + 
					url_array[url_array.length - 1];
				//make a twitter follow button
				var follow_url = "https://twitter.com/intent/user?screen_name=ThinkBigD";
				var twitter_footer = "<div class='twitter_footer'>";
				twitter_footer += "<div class='social_byline'><span>TWEET BY:</span> <a href='http://twitter.com/ThinkBigD' target='_blank'> Big-D Construction @ThinkBigD</a></div>";
				twitter_footer += "<div class='twitter_nav'><a href='" + reply_url + "' target='_blank'><img src='" +bigd.TEMPLATE_URL+"/images/reply.png'/></a>";
				twitter_footer += "<a href='" + retweet_url + "' target='_blank'><img src='" +bigd.TEMPLATE_URL+"/images/retweet.png'/></a></div>";
				twitter_footer += "</div>";
				jQuery(".tweet-text").after(twitter_footer);
			}
		},
		facebook: {
			init: function() {
				//facebook jquery
				if(jQuery('.rfbp-timestamp').length > 0) {
					var fb_date_array = jQuery('.rfbp-timestamp').attr('title').split(",");
					var fb_day_month = fb_date_array[1].split(" ");
					var fb_day = fb_day_month[2];
					var fb_month = fb_day_month[1].substring(0,3).toUpperCase();

					var date_html = '<div class="date">' + 
						'<div class="content">' + fb_day + '<br><span>' + fb_month +'</span></div>' +
					'</div>';
					jQuery(".recent-facebook-posts .rfbp-post").before(date_html);
				}

				var fb_footer = '<div class="social_byline">' +
					'<span>POSTED BY:</span>' +
					'<a href="https://www.facebook.com/pages/Big-D-Construction/273622216001" target="_blank">  ThinkBigD</a>' +
				'</div>' +
				'<div class="fb-break"></div>';
				jQuery(".rfbp-post").after(fb_footer);

                jQuery('.rfbp-post').each(function() {
                    if(jQuery('.rfbp-image', this).attr('src')) {
                        var fb_image_url_array = jQuery(".rfbp-image", this).attr('src').split("?");
                        jQuery(".rfbp-image", this).attr('src', fb_image_url_array[0] );
                        var fb_image = jQuery('.rfbp-image-wrap', this).detach();
                        jQuery('.rfbp-text', this).before(fb_image);	
                    }
                });


				var fb_byline = jQuery('.rfbp-post .social_byline').detach();
				jQuery('.recent-facebook-posts').append(fb_byline);
			}
		},
		mobile: {
			init: function() {
				bigd.news.social.facebook.init();
				bigd.news.social.twitter.init();
			}
		}
	},
	rankings: {
		init: function() {
			bigd.news.init();
		}
	},
	media: {
		init: function() {
			bigd.news.init();
			jQuery('#video-tabs').easytabs({ updateHash: false });
			jQuery('[data-action="video-box"]').each(function() {
				var videoBox = new bigd.videoBox(this);
			});
		},
		mobile: {
			init: function() {
				jQuery('[data-action="video-box"]').each(function() {
					var videoBox = new bigd.videoBox(this);
				});
			}
		}
	},
	community: {
		init: function() {
			bigd.news.init();
		}
	},
	mobile: {
		init: function() {
			bigd.news.social.mobile.init();
			bigd.news.media.mobile.init();
			jQuery('.main-container').animate({'opacity': 1}, 200);
		}
	}
};

bigd.Gallery = function(el) {
	var self = this;
	self.el = jQuery(el);
	self.gallery = self.el.find('.content .gallery').html();

	var raw_date = self.el.find('.date .content').html().split(' ');
	var date = raw_date[0].trim() + '<br /><span>' + raw_date[1].trim() + '</span>';
	self.el
		.find('.content .gallery').detach().end()
		.find('.date .content').html(date).end()
		.find('.gallery-window').html(self.gallery);
	if(!bigd.IS_MOBILE) {
		self.el.find('.gallery-icon a').each(function() {
			jQuery(this).append('<span class="gallery-icon-mask">+</span>');
		});
	}
};

bigd.PostAccordion = function() {
	var self = this;
	self.posts = [];
	jQuery('.news-post').each(function() {
		var post = new bigd.PostAccordionItem(this);
		post.parent = self;
		self.posts.push(post);
	});
};
bigd.PostAccordion.prototype.closeAll = function() {
	var self = this;
	for(var i = 0; i < self.posts.length; i++) {
		self.posts[i].close();
	}
};
bigd.PostAccordionItem = function(el) {
	var self = this;
	self.newHeight = (bigd.IS_MOBILE) ? 200 : 424;
	self.el = jQuery(el);
	self.originalHeight = self.el.find('.text').height();
	self.el	
		.find('.text').css('height', self.newHeight).end()
		.find('> .content').append('' +
			'<div class="read-more"><span>Read More &rsaquo;</span></div>' +
			'<div class="close-more"><span>Close &nbsp;&nbsp;&#x2715;</span></div>'
		).end()
		.find('.read-more').on('click', function(e) {
			e.preventDefault();
			jQuery.scrollTo(jQuery(this).closest('.news-post'), { duration: 500, offsetTop: -150 });
			self.open();
		}).end()
		.find(".close-more").on('click', function(e) {
			e.preventDefault();
			jQuery.scrollTo(jQuery(this).closest('.news-post'), { duration: 500, offsetTop: -150 });
			self.close();
		});
	self.close();
};
bigd.PostAccordionItem.prototype.open = function() {
	var self = this;
	self.parent.closeAll();
	if(bigd.IS_MOBILE) {
		self.el.closest('.mobile-accordion-content').css('height', 'auto');
	}
	self.el
		.addClass('open')
		.find('.text').css('height', self.originalHeight).end()
		.find('.read-more').hide().end()
		.find('.close-more').show();
	setTimeout(function() {
		jQuery.waypoints('refresh');
	}, 1100);
};
bigd.PostAccordionItem.prototype.close = function() {
	var self = this;
	self.el
		.removeClass('open')
		.find(".text").height(self.newHeight).end()
		.find(".read-more").show().end()
		.find(".close-more").hide();
	setTimeout(function() {
		jQuery.waypoints('refresh');
	}, 1100);
};
