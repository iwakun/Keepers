<?php
require_once('includes/boot.inc.php');
require_once(GG_ROOT.'/admin/admin_header.php');

// Determine if any of the filter functions are being used. If not, display only yesterday - tommorrow
$noFilter = true;
foreach($_GET as $key => $arg) {
    if($arg != '') {
        $noFilter = false;
    }
}

$form = new Form($_GET);

if(!$noFilter) {
    $s = new Search();
    $s->addTable('coupons');
    $s->switchUserActive();
    $s->addReturnField('CouponID');
    $s->addCondition('coupons.site = "'.GG_SITE.'"');
    if($form->getValue('startDate')) {
        $start = $form->getValue('startDate');
        $date = explode("/", $start);
        $start = $date[2].'-'.$date[0].'-'.$date[1];
        $s->addCondition("`date` >= '$start'");
    }
    if($form->getValue('endDate')) {
        $end = $form->getValue('endDate');
        $date = explode("/", $end);
        $end = $date[2].'-'.$date[0].'-'.$date[1];
        $s->addCondition("`date` <= '$end'");
    }
    if($form->getValue('issued_to')) {
        $issued_to = $s->clean($form->getValue('issued_to'));
        $s->addCondition("issued_to LIKE '%$issued_to%'");
    }
    if($form->getValue('inactive') && $form->getValue('inactive') == '1') {
        $s->addCondition("status = '0'");
    }
    if($form->getValue('CouponDescription')) {
        $description = $s->clean($form->getValue('CouponDescription'));
        $s->addCondition("CouponDescription LIKE '%$description%'");
    }
    if($form->getValue('CouponCode')) {
        $code = $s->clean($form->getValue('CouponCode'));
        $s->addCondition("CouponCode LIKE '%$code%'");
    }
    $s->addAdditional('ORDER BY `date` DESC, CouponCode DESC');
    $sql = $s->doLikeQuery();
    $couponList = $db->read($sql);
    $coupons = array();
    foreach($couponList as $_coupon) {
        $coupons[] = new Coupon($_coupon['CouponID']);
    }
}

/*
header('Content-type: application/octet-stream');
header('Content-Disposition: attachment; filename="coupons.csv"');
*/

print(
    "Date,".
    "Code,".
    "Expiration Date,".
    "Category,".
    "Category Id,".
    "Category Types,".
    "Type,".
    "Amount,".
    "Description,".
    "Status,".
    "Issued to,".
    "Uses\n"
);
foreach($coupons as $row) {
    print(
        "\"{$row->date}\",".
        "\"{$row->CouponCode}\",".
        "\"{$row->expiration_date}\",".
        "\"{$row->CouponCategory}\",".
        "\"{$row->CouponCategoryID}\",".
        "\"{$row->CouponCategoryType}\",".
        "\"{$row->CouponType}\",".
        "\"{$row->CouponAmount}\",".
        "\"{$row->status}\",".
        "\"{$row->issued_to}\",".
        "\"{$row->uses}\"\n"
    );
}
